local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

local AnimacionesTab = _G.Window:CreateTab("Animaciones", nil)

local selectedSpeed = 1
local currentTrack = nil
local buttonsCreated = false
local buttonsCreatedR6 = false

-- Variables para los binds
local bindsEnabled = false
local lastAnimationId = nil

-- Variables para los botones mÃ³viles
local mobileButtonsGui = nil
local playButton = nil
local stopButton = nil

-- Detectar si es mÃ³vil
local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled

-- Devuelve el Humanoid actual
local function getHumanoid()
	local char = LocalPlayer.Character
	if char then
		return char:FindFirstChildWhichIsA("Humanoid")
	end
	return nil
end

-- Asegura que el Animator estÃ© disponible
local function getAnimator(Humanoid)
	for i = 1, 10 do
		local animator = Humanoid:FindFirstChildOfClass("Animator")
		if animator then return animator end
		animator = Instance.new("Animator")
		animator.Parent = Humanoid
		task.wait(0.05)
	end
	return nil
end

-- Carga animaciÃ³n con seguridad
local function safePlayAnim(animId)
	local humanoid = getHumanoid()
	if not humanoid then return end

	local anim = Instance.new("Animation")
	anim.AnimationId = animId

	local success, track
	for attempt = 1, 5 do
		local animator = getAnimator(humanoid)
		if not animator then
			warn("âŒ No se pudo obtener Animator.")
			return
		end
		success, track = pcall(function()
			return animator:LoadAnimation(anim)
		end)
		if success and track then
			track:Play()
			track:AdjustSpeed(selectedSpeed)
			currentTrack = track
			lastAnimationId = animId
			return
		end
		task.wait(0.1)
	end
	warn("âš ï¸ No se pudo cargar la animaciÃ³n tras varios intentos.")
end

-- FunciÃ³n para reproducir la Ãºltima animaciÃ³n
local function playLastAnimation()
	if lastAnimationId then
		safePlayAnim(lastAnimationId)
	end
end

-- FunciÃ³n para detener animaciÃ³n
local function stopCurrentAnimation()
	local humanoid = getHumanoid()
	if humanoid then
		for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
			track:Stop()
		end
	end
	currentTrack = nil
end

-- Crear funciÃ³n para hacer un botÃ³n draggable
local function makeDraggable(frame)
	local dragging = false
	local dragInput
	local dragStart
	local startPos

	local function update(input)
		local delta = input.Position - dragStart
		frame.Position = UDim2.new(
			startPos.X.Scale,
			startPos.X.Offset + delta.X,
			startPos.Y.Scale,
			startPos.Y.Offset + delta.Y
		)
	end

	frame.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			dragStart = input.Position
			startPos = frame.Position

			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
				end
			end)
		end
	end)

	frame.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseMovement then
			dragInput = input
		end
	end)

	UserInputService.InputChanged:Connect(function(input)
		if input == dragInput and dragging then
			update(input)
		end
	end)
end

-- Crear botones mÃ³viles
local function createMobileButtons()
	if mobileButtonsGui then
		mobileButtonsGui:Destroy()
	end

	-- Crear ScreenGui
	mobileButtonsGui = Instance.new("ScreenGui")
	mobileButtonsGui.Name = "MobileAnimationButtons"
	mobileButtonsGui.ResetOnSpawn = false
	mobileButtonsGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	mobileButtonsGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

	-- BotÃ³n de Reproducir AnimaciÃ³n (Verde)
	playButton = Instance.new("TextButton")
	playButton.Name = "PlayButton"
	playButton.Size = UDim2.new(0, 80, 0, 80)
	playButton.Position = UDim2.new(0.1, 0, 0.7, 0)
	playButton.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
	playButton.Text = "â–¶ï¸"
	playButton.TextColor3 = Color3.new(1, 1, 1)
	playButton.TextSize = 35
	playButton.Font = Enum.Font.GothamBold
	playButton.AutoButtonColor = false
	playButton.Parent = mobileButtonsGui

	-- Esquinas redondeadas para botÃ³n play
	local playCorner = Instance.new("UICorner")
	playCorner.CornerRadius = UDim.new(0.25, 0)
	playCorner.Parent = playButton

	-- Sombra para botÃ³n play
	local playShadow = Instance.new("UIStroke")
	playShadow.Color = Color3.fromRGB(30, 130, 76)
	playShadow.Thickness = 4
	playShadow.Transparency = 0.5
	playShadow.Parent = playButton

	-- Hacer draggable el botÃ³n play
	makeDraggable(playButton)

	-- FunciÃ³n del botÃ³n play
	playButton.MouseButton1Click:Connect(function()
		playLastAnimation()
		-- Efecto visual al presionar
		playButton.BackgroundColor3 = Color3.fromRGB(39, 174, 96)
		task.wait(0.1)
		playButton.BackgroundColor3 = Color3.fromRGB(46, 204, 113)
	end)

	-- BotÃ³n de Detener AnimaciÃ³n (Rojo)
	stopButton = Instance.new("TextButton")
	stopButton.Name = "StopButton"
	stopButton.Size = UDim2.new(0, 80, 0, 80)
	stopButton.Position = UDim2.new(0.9, -80, 0.7, 0)
	stopButton.BackgroundColor3 = Color3.fromRGB(231, 76, 60)
	stopButton.Text = "â¹ï¸"
	stopButton.TextColor3 = Color3.new(1, 1, 1)
	stopButton.TextSize = 35
	stopButton.Font = Enum.Font.GothamBold
	stopButton.AutoButtonColor = false
	stopButton.Parent = mobileButtonsGui

	-- Esquinas redondeadas para botÃ³n stop
	local stopCorner = Instance.new("UICorner")
	stopCorner.CornerRadius = UDim.new(0.25, 0)
	stopCorner.Parent = stopButton

	-- Sombra para botÃ³n stop
	local stopShadow = Instance.new("UIStroke")
	stopShadow.Color = Color3.fromRGB(192, 57, 43)
	stopShadow.Thickness = 4
	stopShadow.Transparency = 0.5
	stopShadow.Parent = stopButton

	-- Hacer draggable el botÃ³n stop
	makeDraggable(stopButton)

	-- FunciÃ³n del botÃ³n stop
	stopButton.MouseButton1Click:Connect(function()
		stopCurrentAnimation()
		-- Efecto visual al presionar
		stopButton.BackgroundColor3 = Color3.fromRGB(192, 57, 43)
		task.wait(0.1)
		stopButton.BackgroundColor3 = Color3.fromRGB(231, 76, 60)
	end)

	-- Etiqueta para el botÃ³n Play
	local playLabel = Instance.new("TextLabel")
	playLabel.Size = UDim2.new(1, 0, 0, 20)
	playLabel.Position = UDim2.new(0, 0, 1, 5)
	playLabel.BackgroundTransparency = 1
	playLabel.Text = "Reproducir"
	playLabel.TextColor3 = Color3.new(1, 1, 1)
	playLabel.TextSize = 12
	playLabel.Font = Enum.Font.Gotham
	playLabel.TextStrokeTransparency = 0.5
	playLabel.Parent = playButton

	-- Etiqueta para el botÃ³n Stop
	local stopLabel = Instance.new("TextLabel")
	stopLabel.Size = UDim2.new(1, 0, 0, 20)
	stopLabel.Position = UDim2.new(0, 0, 1, 5)
	stopLabel.BackgroundTransparency = 1
	stopLabel.Text = "Detener"
	stopLabel.TextColor3 = Color3.new(1, 1, 1)
	stopLabel.TextSize = 12
	stopLabel.Font = Enum.Font.Gotham
	stopLabel.TextStrokeTransparency = 0.5
	stopLabel.Parent = stopButton
end

-- Eliminar botones mÃ³viles
local function removeMobileButtons()
	if mobileButtonsGui then
		mobileButtonsGui:Destroy()
		mobileButtonsGui = nil
		playButton = nil
		stopButton = nil
	end
end

-- Botones para animaciones R15
local function setupUI_R15()
	if buttonsCreated then return end
	buttonsCreated = true

	AnimacionesTab:CreateSection("Animaciones R15")

	AnimacionesTab:CreateButton({
		Name = "âŒ Quitar AnimaciÃ³n",
		Callback = function()
			stopCurrentAnimation()
		end
	})

	-- Toggle para activar/desactivar los binds
	AnimacionesTab:CreateToggle({
		Name = isMobile and "Activar Botones de AnimaciÃ³n" or "Activar Binds de AnimaciÃ³n",
		CurrentValue = false,
		Callback = function(value)
			bindsEnabled = value
			
			-- Si es mÃ³vil, mostrar/ocultar botones
			if isMobile then
				if value then
					createMobileButtons()
				else
					removeMobileButtons()
				end
			end
		end
	})

	-- Solo crear keybinds si NO es mÃ³vil
	if not isMobile then
		-- Bind 1: Reproducir Ãºltima animaciÃ³n (Tecla Q)
		AnimacionesTab:CreateKeybind({
			Name = "Reproducir AnimaciÃ³n",
			CurrentKeybind = "Q",
			Callback = function(key)
				if bindsEnabled then
					playLastAnimation()
				end
			end
		})

		-- Bind 2: Quitar animaciÃ³n actual (Tecla E)
		AnimacionesTab:CreateKeybind({
			Name = "Quitar AnimaciÃ³n",
			CurrentKeybind = "E",
			Callback = function(key)
				if bindsEnabled then
					stopCurrentAnimation()
				end
			end
		})
	end

	AnimacionesTab:CreateSlider({
		Name = "Velocidad de animaciÃ³n",
		Range = {0, 10},
		Increment = 0.1,
		Suffix = "x",
		CurrentValue = selectedSpeed,
		Callback = function(value)
			selectedSpeed = value
			if currentTrack then
				currentTrack:AdjustSpeed(value)
			end
		end
	})

	task.spawn(function()
		-- Primero cargar desde la primer API
		local success1, emotes1 = pcall(function()
			local raw = game:HttpGet("https://pastebin.com/raw/h4981hMA")
			return HttpService:JSONDecode(raw)
		end)

		if success1 and emotes1 then
			for _, emote in ipairs(emotes1) do
				if emote.name and emote.animationid then
					AnimacionesTab:CreateButton({
						Name = emote.name,
						Callback = function()
							local humanoid = getHumanoid()
							if humanoid then
								for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
									track:Stop()
								end
								safePlayAnim(emote.animationid)
							end
						end
					})
				end
			end

			-- Luego cargar la segunda API
			local success2, emotes2 = pcall(function()
				local raw = game:HttpGet("https://raw.githubusercontent.com/Joystickplays/AFEM/refs/heads/main/emotes.json")
				return HttpService:JSONDecode(raw)
			end)

			if success2 and emotes2 then
				for _, emote in ipairs(emotes2) do
					if emote.name and emote.animationid then
						AnimacionesTab:CreateButton({
							Name = emote.name,
							Callback = function()
								local humanoid = getHumanoid()
								if humanoid then
									for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
										track:Stop()
									end
									safePlayAnim(emote.animationid)
								end
							end
						})
					end
				end
			else
				warn("âŒ Error al cargar emotes R15 desde GitHub:", emotes2)
			end
		else
			warn("âŒ Error al cargar emotes R15 desde pastebin:", emotes1)
		end
	end)
end

-- Botones para animaciones R6
local function setupUI_R6()
	if buttonsCreatedR6 then return end
	buttonsCreatedR6 = true

	AnimacionesTab:CreateSection("Animaciones R6")

	AnimacionesTab:CreateButton({
		Name = "âŒ Quitar AnimaciÃ³n R6",
		Callback = function()
			local humanoid = getHumanoid()
			if humanoid then
				for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
					track:Stop()
				end
			end
			currentTrack = nil
		end
	})

	task.spawn(function()
		local success, emotes = pcall(function()
			local raw = game:HttpGet("https://pastebin.com/raw/iUCKWXKV")
			return HttpService:JSONDecode(raw)
		end)

		if success then
			for _, emote in ipairs(emotes) do
				if emote.name and emote.animationid then
					AnimacionesTab:CreateButton({
						Name = "[R6] " .. emote.name,
						Callback = function()
							local humanoid = getHumanoid()
							if humanoid then
								for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
									track:Stop()
								end
								safePlayAnim(emote.animationid)
							end
						end
					})
				end
			end
		else
			warn("âŒ Error al cargar emotes R6:", emotes)
		end
	end)
end

-- Carga los botones al presionar
AnimacionesTab:CreateButton({
	Name = "â–¶ï¸ Cargar Animaciones R15",
	Callback = setupUI_R15
})

AnimacionesTab:CreateButton({
	Name = "â–¶ï¸ Cargar Animaciones R6",
	Callback = setupUI_R6
})

-- Reset de animaciones al respawn
LocalPlayer.CharacterAdded:Connect(function()
	currentTrack = nil
	lastAnimationId = nil
	-- Limpiar botones mÃ³viles si estaban activos
	if isMobile and bindsEnabled then
		removeMobileButtons()
		if bindsEnabled then
			task.wait(0.5)
			createMobileButtons()
		end
	end
end)

-- Limpiar botones al destruir el script
game:GetService("RunService").Heartbeat:Connect(function()
	if mobileButtonsGui and not mobileButtonsGui.Parent then
		mobileButtonsGui = nil
		playButton = nil
		stopButton = nil
	end
end)







 
 
























--// Interfaz de animaciones (estilo SystemBroken con carga diferida para Rayfield)

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local plr = Players.LocalPlayer

-- URL con tu JSON (cÃ¡mbiala si actualizas)
local animsURL = "https://pastebin.com/raw/14q07TEP"

-- Variables internas
local animData = nil
local buttonsCreated = false

--// Funciones base
local function StopAnimForCharacter(char)
	if not char then return end
	local hum = char:FindFirstChildOfClass("Humanoid")
	if not hum then return end
	for _, t in ipairs(hum:GetPlayingAnimationTracks()) do
		pcall(function() t:Stop() end)
	end
end

local function normAnimId(a)
	if not a then return nil end
	a = tostring(a)
	if a:match("^%d+$") then
		return "rbxassetid://"..a
	end
	return a
end

local function applySetSystemBroken(setName)
	if not animData then
		warn("âš ï¸ No hay datos cargados todavÃ­a.")
		return
	end

	local char = plr.Character or plr.CharacterAdded:Wait()
	local hum = char:FindFirstChildOfClass("Humanoid")
	local animate = char:FindFirstChild("Animate")
	if not hum or not animate then
		warn("No se encontrÃ³ Humanoid o Animate en el personaje.")
		return
	end

	local data = animData[setName]
	if not data then
		warn("Set no encontrado:", setName)
		return
	end

	animate.Disabled = true
	StopAnimForCharacter(char)

	-- Normalizar IDs
	local idle1 = normAnimId(data.idle1)
	local idle2 = normAnimId(data.idle2)
	local walk = normAnimId(data.walk)
	local run = normAnimId(data.run or data.walk)
	local jump = normAnimId(data.jump)
	local climb = normAnimId(data.climb)
	local fall = normAnimId(data.fall)

	-- Asignar animaciones
	if animate:FindFirstChild("idle") then
		local idle = animate.idle
		if idle:FindFirstChild("Animation1") and idle1 then
			idle.Animation1.AnimationId = idle1
		end
		if idle:FindFirstChild("Animation2") and idle2 then
			idle.Animation2.AnimationId = idle2
		end
	end

	if animate:FindFirstChild("walk") and walk then
		local w = animate.walk:FindFirstChild("WalkAnim") or animate.walk:FindFirstChildWhichIsA("Animation")
		if w then w.AnimationId = walk end
	end

	if animate:FindFirstChild("run") and run then
		local r = animate.run:FindFirstChild("RunAnim")
		if not r then
			r = Instance.new("Animation")
			r.Name = "RunAnim"
			r.Parent = animate.run
		end
		r.AnimationId = run
	end

	if animate:FindFirstChild("jump") and jump then
		local j = animate.jump:FindFirstChild("JumpAnim") or animate.jump:FindFirstChildWhichIsA("Animation")
		if j then j.AnimationId = jump end
	end

	if animate:FindFirstChild("climb") and climb then
		local c = animate.climb:FindFirstChild("ClimbAnim") or animate.climb:FindFirstChildWhichIsA("Animation")
		if c then c.AnimationId = climb end
	end

	if animate:FindFirstChild("fall") and fall then
		local f = animate.fall:FindFirstChild("FallAnim") or animate.fall:FindFirstChildWhichIsA("Animation")
		if f then f.AnimationId = fall end
	end

	-- Recarga limpia
	pcall(function()
		hum:ChangeState(Enum.HumanoidStateType.RunningNoPhysics)
		task.wait(0.05)
		hum:ChangeState(Enum.HumanoidStateType.Running)
		StopAnimForCharacter(char)
		hum:Move(Vector3.zero)
	end)

	animate.Disabled = false
	print("âœ… Animaciones aplicadas correctamente ->", setName)

	if Rayfield and Rayfield.Notify then
		Rayfield:Notify({
			Title = "Animaciones Aplicadas",
			Content = "Se aplicÃ³ el set: " .. setName,
			Duration = 3,
			Image = 4483362458
		})
	end
end

--// Interfaz Rayfield

AnimacionesTab:CreateButton({
	Name = "ðŸ“¦ Cargar Animaciones",
	Callback = function()
		if buttonsCreated then return end
		buttonsCreated = true

		local success, data = pcall(function()
			return HttpService:JSONDecode(game:HttpGet(animsURL))
		end)

		if not success or type(data) ~= "table" then
			warn("No se pudo cargar el JSON de animaciones.")
			if Rayfield and Rayfield.Notify then
				Rayfield:Notify({
					Title = "Error",
					Content = "No se pudo cargar el JSON.",
					Duration = 4,
					Image = 4483362458
				})
			end
			return
		end

		animData = data

		for setName, _ in pairs(animData) do
			AnimacionesTab:CreateButton({
				Name = setName,
				Callback = function()
					applySetSystemBroken(setName)
				end
			})
		end

		if Rayfield and Rayfield.Notify then
			Rayfield:Notify({
				Title = "Animaciones Cargadas",
				Content = "Los botones fueron generados correctamente.",
				Duration = 3,
				Image = 4483362458
			})
		end
	end
})
