task.spawn(function()
    repeat task.wait() until game:IsLoaded()
    repeat task.wait() until _G.AimbotTab

    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local UserInputService = game:GetService("UserInputService")
    local Camera = workspace.CurrentCamera
    local LocalPlayer = Players.LocalPlayer
    local AimbotTab = _G.AimbotTab

    AimbotTab:CreateSection("Aimbot Movil/Pc")

    -- ===== CONFIGURACIÓN =====
    local AimbotSettings = {
        Enabled = false,
        ESPEnabled = false,
        FOVRadius = 350,
        FOVColor = Color3.fromRGB(0, 0, 255),
        ESPColor = Color3.fromRGB(0, 0, 255),
        ESPEnemyColor = Color3.fromRGB(255, 0, 0),
        ESPSizeMultiplier = 10,
        Sensitivity = 0,
        AimPart = "Head",
        TeamCheckEnabled = false,
        TracersEnabled = false,
        TracerColor = Color3.fromRGB(0, 0, 255),
        TracerEnemyColor = Color3.fromRGB(255, 0, 0),
        AutoAimEnabled = false,
        OnlyClosePlayers = false,
        CloseDistanceThreshold = 100,
        WallCheck = false,
        UseAlternativeESP = false,
        ShowNamesOnly = false,
        UseTeamColors = false,
    }

    local Holding = false
    local drawingSupported = false
    
    -- ===== VERIFICAR DRAWING =====
    local success = pcall(function()
        local testCircle = Drawing.new("Circle")
        testCircle:Remove()
        drawingSupported = true
    end)

    -- ===== FOV CIRCLE =====
    local FOVCircle
    if drawingSupported then
        pcall(function()
            FOVCircle = Drawing.new("Circle")
            FOVCircle.Filled = false
            FOVCircle.Thickness = 2
            FOVCircle.NumSides = 64
            FOVCircle.Transparency = 0.8
            FOVCircle.Visible = false
        end)
    end

    -- ===== FUNCIONES DE COLOR =====
    local function GetColorByTeam(player)
        if not AimbotSettings.UseTeamColors then
            return AimbotSettings.ESPColor
        end
        return (player.Team == LocalPlayer.Team) and AimbotSettings.ESPColor or AimbotSettings.ESPEnemyColor
    end

    local function GetTracerColorByTeam(player)
        if not AimbotSettings.UseTeamColors then
            return AimbotSettings.TracerColor
        end
        return (player.Team == LocalPlayer.Team) and AimbotSettings.TracerColor or AimbotSettings.TracerEnemyColor
    end

    -- ===== VERIFICACIÓN DE VISIBILIDAD =====
    local function IsVisible(targetChar)
        if not AimbotSettings.WallCheck then return true end
        
        local success, result = pcall(function()
            local targetPos = targetChar.HumanoidRootPart.Position
            local direction = (targetPos - Camera.CFrame.Position).Unit * (targetPos - Camera.CFrame.Position).Magnitude
            
            local rayParams = RaycastParams.new()
            rayParams.FilterDescendantsInstances = {LocalPlayer.Character, targetChar}
            rayParams.FilterType = Enum.RaycastFilterType.Blacklist
            rayParams.IgnoreWater = true
            
            local rayResult = workspace:Raycast(Camera.CFrame.Position, direction, rayParams)
            return rayResult == nil or targetChar:IsAncestorOf(rayResult.Instance)
        end)
        
        return success and result
    end

    -- ===== OBTENER JUGADOR MÁS CERCANO =====
    local function GetClosestPlayer()
        if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
            return nil
        end
        
        local closestPlayer, shortestDistance = nil, math.huge
        local mousePos = UserInputService:GetMouseLocation()
        
        for _, v in pairs(Players:GetPlayers()) do
            if v ~= LocalPlayer and v.Character then
                local char = v.Character
                local hrp = char:FindFirstChild("HumanoidRootPart")
                local hum = char:FindFirstChild("Humanoid")
                
                if hrp and hum and hum.Health > 0 then
                    -- Verificar equipo
                    if AimbotSettings.TeamCheckEnabled and v.Team == LocalPlayer.Team then 
                        continue 
                    end
                    
                    -- Verificar paredes
                    if not IsVisible(char) then continue end
                    
                    -- Verificar si está en pantalla
                    local screenPoint, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                    if not onScreen then continue end
                    
                    -- Calcular distancia en pantalla
                    local distance = (Vector2.new(screenPoint.X, screenPoint.Y) - mousePos).Magnitude
                    
                    -- Verificar FOV
                    if distance >= AimbotSettings.FOVRadius then continue end
                    
                    -- Verificar distancia en mundo
                    if AimbotSettings.OnlyClosePlayers then
                        local worldDist = (hrp.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                        if worldDist > AimbotSettings.CloseDistanceThreshold then continue end
                    end
                    
                    -- Actualizar más cercano
                    if distance < shortestDistance then
                        shortestDistance = distance
                        closestPlayer = v
                    end
                end
            end
        end
        
        return closestPlayer
    end

    -- ===== INPUT HANDLING =====
    UserInputService.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            Holding = true
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton2 then
            Holding = false
        end
    end)

    -- ===== SISTEMA DE CACHÉ =====
    local ESPCache = {}
    local TracerCache = {}
    local BillboardESPs = {}
    local ESPFolder = Instance.new("Folder", game.CoreGui)
    ESPFolder.Name = "ESPFolder_" .. math.random(1, 10000)

    -- ===== FUNCIONES ESP (Drawing API) =====
    local function UpdateESP(player, color, position, size)
        if not ESPCache[player] then
            local box, text
            
            pcall(function()
                box = Drawing.new("Square")
                box.Color = color
                box.Thickness = 2
                box.Filled = false
                box.Transparency = 1
                box.Visible = true
                box.ZIndex = 1
            end)
            
            pcall(function()
                text = Drawing.new("Text")
                text.Text = player.Name
                text.Size = 18
                text.Center = true
                text.Outline = true
                text.Color = color
                text.Visible = true
                text.ZIndex = 2
            end)
            
            if box and text then
                ESPCache[player] = {box = box, text = text}
            else
                return false
            end
        end
        
        local cache = ESPCache[player]
        if not cache then return false end
        
        pcall(function()
            if cache.box then
                if AimbotSettings.ShowNamesOnly then
                    cache.box.Visible = false
                else
                    cache.box.Color = color
                    cache.box.Size = size
                    cache.box.Position = position
                    cache.box.Visible = true
                end
            end
            
            if cache.text then
                cache.text.Text = player.Name
                cache.text.Color = color
                cache.text.Position = Vector2.new(position.X + size.X / 2, position.Y - 20)
                cache.text.Visible = true
            end
        end)
        
        return true
    end

    local function UpdateTracer(player, color, fromPos, toPos)
        if not TracerCache[player] then
            local line
            
            pcall(function()
                line = Drawing.new("Line")
                line.Thickness = 2
                line.Transparency = 0.9
                line.Visible = true
                line.ZIndex = 1
            end)
            
            if line then
                TracerCache[player] = {line = line}
            else
                return false
            end
        end
        
        local cache = TracerCache[player]
        if not cache or not cache.line then return false end
        
        pcall(function()
            cache.line.Color = color
            cache.line.From = fromPos
            cache.line.To = toPos
            cache.line.Visible = true
        end)
        
        return true
    end

    -- ===== LIMPIEZA DE CACHÉ =====
    local function HideAllESP()
        for _, cache in pairs(ESPCache) do
            pcall(function()
                if cache.box then cache.box.Visible = false end
                if cache.text then cache.text.Visible = false end
            end)
        end
    end

    local function HideAllTracers()
        for _, cache in pairs(TracerCache) do
            pcall(function()
                if cache.line then cache.line.Visible = false end
            end)
        end
    end

    local function RemoveAllESP()
        for _, cache in pairs(ESPCache) do
            pcall(function()
                if cache.box then cache.box:Remove() end
                if cache.text then cache.text:Remove() end
            end)
        end
        ESPCache = {}
    end

    local function RemoveAllTracers()
        for _, cache in pairs(TracerCache) do
            pcall(function()
                if cache.line then cache.line:Remove() end
            end)
        end
        TracerCache = {}
    end

    -- ===== ESP ALTERNATIVO (BillboardGui) =====
    local function ClearAllBillboardESPs()
        for player, billboard in pairs(BillboardESPs) do
            pcall(function()
                if billboard and billboard.Parent then
                    billboard:Destroy()
                end
            end)
        end
        BillboardESPs = {}
    end

    local function CreateBillboardESP(player)
        local char = player.Character
        if not char then return end
        
        local hrp = char:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        
        if BillboardESPs[player] then
            pcall(function() 
                if BillboardESPs[player].Parent then
                    BillboardESPs[player]:Destroy() 
                end
            end)
        end
        
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "ESP_" .. player.Name
        billboard.Adornee = hrp
        billboard.Size = UDim2.new(4, 0, 5, 0)
        billboard.StudsOffset = Vector3.new(0, 1, 0)
        billboard.AlwaysOnTop = true
        billboard.ResetOnSpawn = false
        billboard.Parent = ESPFolder
        
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, 0, 1, 0)
        frame.BackgroundTransparency = 1
        frame.BorderSizePixel = 0
        frame.Parent = billboard
        
        local borders = {}
        local function createBorder(position, size)
            local border = Instance.new("Frame")
            border.Position = position
            border.Size = size
            border.BackgroundColor3 = GetColorByTeam(player)
            border.BorderSizePixel = 0
            border.Parent = frame
            table.insert(borders, border)
            return border
        end
        
        createBorder(UDim2.new(0, 0, 0, 0), UDim2.new(1, 0, 0, 2))
        createBorder(UDim2.new(0, 0, 1, -2), UDim2.new(1, 0, 0, 2))
        createBorder(UDim2.new(0, 0, 0, 0), UDim2.new(0, 2, 1, 0))
        createBorder(UDim2.new(1, -2, 0, 0), UDim2.new(0, 2, 1, 0))
        
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Size = UDim2.new(1, 0, 0, 20)
        nameLabel.Position = UDim2.new(0, 0, -0.15, 0)
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = player.Name
        nameLabel.TextColor3 = GetColorByTeam(player)
        nameLabel.TextStrokeTransparency = 0.5
        nameLabel.Font = Enum.Font.SourceSansBold
        nameLabel.TextSize = 14
        nameLabel.Parent = frame
        
        BillboardESPs[player] = billboard
    end

    -- ===== SISTEMA RAINBOW =====
    local rainbowEnabled = false
    local rainbowSpeed = 5

    local function GetRainbowColor()
        return Color3.fromHSV((tick() * rainbowSpeed / 10) % 1, 1, 1)
    end

    -- ===== LOOP PRINCIPAL OPTIMIZADO =====
    -- CLAVE: Solo se ejecuta cuando algo está ACTIVO
    local lastFrameTime = tick()
    local frameSkip = 0
    
    RunService.RenderStepped:Connect(function()
        -- ===== OPTIMIZACIÓN #1: Saltar frames si no hay nada activo =====
        local isAnyFeatureActive = AimbotSettings.Enabled 
            or AimbotSettings.ESPEnabled 
            or AimbotSettings.TracersEnabled 
            or AimbotSettings.UseAlternativeESP
            or rainbowEnabled
        
        if not isAnyFeatureActive then
            -- NO hacer NADA si todo está desactivado
            frameSkip = frameSkip + 1
            if frameSkip >= 30 then -- Solo limpiar cada 30 frames
                HideAllESP()
                HideAllTracers()
                frameSkip = 0
            end
            return
        end
        
        -- ===== OPTIMIZACIÓN #2: Limitar FPS del script a 30 =====
        local currentTime = tick()
        if currentTime - lastFrameTime < 0.033 then -- ~30 FPS
            return
        end
        lastFrameTime = currentTime
        
        -- ===== RAINBOW =====
        if rainbowEnabled then
            local rainbowColor = GetRainbowColor()
            AimbotSettings.FOVColor = rainbowColor
            AimbotSettings.ESPColor = rainbowColor
            AimbotSettings.TracerColor = rainbowColor
            if AimbotSettings.UseTeamColors then
                AimbotSettings.ESPEnemyColor = rainbowColor
                AimbotSettings.TracerEnemyColor = rainbowColor
            end
        end
        
        -- ===== FOV CIRCLE =====
        if drawingSupported and FOVCircle then
            local shouldShowFOV = (Holding or AimbotSettings.AutoAimEnabled) and AimbotSettings.Enabled
            
            if shouldShowFOV then
                pcall(function()
                    local mousePos = UserInputService:GetMouseLocation()
                    FOVCircle.Position = Vector2.new(mousePos.X, mousePos.Y)
                    FOVCircle.Radius = AimbotSettings.FOVRadius
                    FOVCircle.Color = AimbotSettings.FOVColor
                    FOVCircle.Visible = true
                end)
            else
                FOVCircle.Visible = false
            end
        end

        -- ===== AIMBOT =====
        if AimbotSettings.Enabled and (Holding or AimbotSettings.AutoAimEnabled) then
            local target = GetClosestPlayer()
            if target and target.Character then
                local aimPart = target.Character:FindFirstChild(AimbotSettings.AimPart)
                if aimPart then
                    pcall(function()
                        local targetPos = aimPart.Position
                        local currentCFrame = Camera.CFrame
                        local targetCFrame = CFrame.new(currentCFrame.Position, targetPos)
                        
                        if AimbotSettings.Sensitivity > 0 then
                            Camera.CFrame = currentCFrame:Lerp(targetCFrame, 0.1 + (AimbotSettings.Sensitivity / 100))
                        else
                            Camera.CFrame = targetCFrame
                        end
                    end)
                end
            end
        end

        -- ===== ESP DRAWING API =====
        if drawingSupported and AimbotSettings.ESPEnabled and not AimbotSettings.UseAlternativeESP then
            -- Primero ocultar todos
            HideAllESP()
            
            -- Luego actualizar solo los visibles
            for _, v in pairs(Players:GetPlayers()) do
                if v ~= LocalPlayer and v.Character then
                    local char = v.Character
                    local hrp = char:FindFirstChild("HumanoidRootPart")
                    local hum = char:FindFirstChild("Humanoid")
                    
                    if hrp and hum and hum.Health > 0 then
                        if AimbotSettings.TeamCheckEnabled and v.Team == LocalPlayer.Team then continue end
                        
                        local rootPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                        
                        if onScreen and rootPos.Z > 0 then
                            local dist = (hrp.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                            local scale = 1000 / (rootPos.Z * 10)
                            local h = math.clamp(scale * AimbotSettings.ESPSizeMultiplier, 20, 400)
                            local w = h / 1.5
                            
                            local color
                            if AimbotSettings.OnlyClosePlayers and dist <= AimbotSettings.CloseDistanceThreshold then
                                color = Color3.fromRGB(255, 0, 0)
                            else
                                color = GetColorByTeam(v)
                            end
                            
                            local position = Vector2.new(rootPos.X - w/2, rootPos.Y - h/2)
                            local size = Vector2.new(w, h)
                            
                            UpdateESP(v, color, position, size)
                        end
                    end
                end
            end
        end

        -- ===== ESP ALTERNATIVO =====
        if AimbotSettings.UseAlternativeESP then
            for _, v in pairs(Players:GetPlayers()) do
                if v ~= LocalPlayer and v.Character then
                    local hum = v.Character:FindFirstChild("Humanoid")
                    local hrp = v.Character:FindFirstChild("HumanoidRootPart")
                    
                    if hum and hrp and hum.Health > 0 then
                        if AimbotSettings.TeamCheckEnabled and v.Team == LocalPlayer.Team then 
                            if BillboardESPs[v] then
                                pcall(function() BillboardESPs[v]:Destroy() end)
                                BillboardESPs[v] = nil
                            end
                            continue 
                        end
                        
                        if not BillboardESPs[v] or not BillboardESPs[v].Parent then
                            CreateBillboardESP(v)
                        end
                    end
                end
            end
        else
            ClearAllBillboardESPs()
        end

        -- ===== TRACERS =====
        if drawingSupported and AimbotSettings.TracersEnabled then
            HideAllTracers()
            
            for _, v in pairs(Players:GetPlayers()) do
                if v ~= LocalPlayer and v.Character then
                    local char = v.Character
                    local hrp = char:FindFirstChild("HumanoidRootPart")
                    local hum = char:FindFirstChild("Humanoid")
                    
                    if hrp and hum and hum.Health > 0 then
                        if AimbotSettings.TeamCheckEnabled and v.Team == LocalPlayer.Team then continue end
                        
                        local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                        
                        if onScreen and screenPos.Z > 0 then
                            local dist = (hrp.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                            
                            local color
                            if AimbotSettings.OnlyClosePlayers and dist <= AimbotSettings.CloseDistanceThreshold then
                                color = Color3.fromRGB(255, 0, 0)
                            else
                                color = GetTracerColorByTeam(v)
                            end
                            
                            local fromPos = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y)
                            local toPos = Vector2.new(screenPos.X, screenPos.Y)
                            
                            UpdateTracer(v, color, fromPos, toPos)
                        end
                    end
                end
            end
        end
    end)

    -- ===== LIMPIEZA DE JUGADORES =====
    Players.PlayerRemoving:Connect(function(player)
        if ESPCache[player] then
            pcall(function()
                if ESPCache[player].box then ESPCache[player].box:Remove() end
                if ESPCache[player].text then ESPCache[player].text:Remove() end
            end)
            ESPCache[player] = nil
        end
        
        if TracerCache[player] then
            pcall(function()
                if TracerCache[player].line then TracerCache[player].line:Remove() end
            end)
            TracerCache[player] = nil
        end
        
        if BillboardESPs[player] then
            pcall(function() BillboardESPs[player]:Destroy() end)
            BillboardESPs[player] = nil
        end
    end)

    -- ===== INTERFAZ DE USUARIO =====
    AimbotTab:CreateToggle({ 
        Name = "Aimbot", 
        CurrentValue = false, 
        Callback = function(v) 
            AimbotSettings.Enabled = v 
        end 
    })

    AimbotTab:CreateToggle({ 
        Name = "Auto Apuntar", 
        CurrentValue = false, 
        Callback = function(v) 
            AimbotSettings.AutoAimEnabled = v 
        end 
    })

    AimbotTab:CreateSlider({ 
        Name = "Tamaño del FOV", 
        Range = {10, 1000}, 
        Increment = 1, 
        CurrentValue = AimbotSettings.FOVRadius, 
        Callback = function(v) 
            AimbotSettings.FOVRadius = v 
        end 
    })

    AimbotTab:CreateColorPicker({ 
        Name = "Color del FOV", 
        Color = AimbotSettings.FOVColor, 
        Callback = function(v) 
            AimbotSettings.FOVColor = v 
        end 
    })

    AimbotTab:CreateToggle({ 
        Name = "ESP", 
        CurrentValue = false, 
        Callback = function(v) 
            AimbotSettings.ESPEnabled = v 
            if not v then HideAllESP() end
        end 
    })

    AimbotTab:CreateToggle({ 
        Name = "ESP Alternativo", 
        CurrentValue = false, 
        Callback = function(v) 
            AimbotSettings.UseAlternativeESP = v 
            if not v then ClearAllBillboardESPs() end
        end 
    })

    AimbotTab:CreateToggle({ 
        Name = "Usar Colores por Equipo", 
        CurrentValue = false, 
        Callback = function(v) 
            AimbotSettings.UseTeamColors = v 
        end 
    })

    AimbotTab:CreateColorPicker({ 
        Name = "Color ESP (Mi Equipo)", 
        Color = AimbotSettings.ESPColor, 
        Callback = function(v) 
            AimbotSettings.ESPColor = v 
        end 
    })

    AimbotTab:CreateColorPicker({ 
        Name = "Color ESP (Enemigos)", 
        Color = AimbotSettings.ESPEnemyColor, 
        Callback = function(v) 
            AimbotSettings.ESPEnemyColor = v 
        end 
    })

    AimbotTab:CreateSlider({ 
        Name = "Tamaño del ESP", 
        Range = {2, 30}, 
        Increment = 0.5, 
        CurrentValue = AimbotSettings.ESPSizeMultiplier, 
        Callback = function(v) 
            AimbotSettings.ESPSizeMultiplier = v 
        end 
    })

    AimbotTab:CreateToggle({ 
        Name = "Mostrar Solo Nombres", 
        CurrentValue = false, 
        Callback = function(v) 
            AimbotSettings.ShowNamesOnly = v 
        end 
    })

    AimbotTab:CreateSlider({ 
        Name = "Sensibilidad del Aim", 
        Range = {0, 100}, 
        Increment = 1, 
        CurrentValue = AimbotSettings.Sensitivity, 
        Callback = function(v) 
            AimbotSettings.Sensitivity = v 
        end 
    })

    AimbotTab:CreateToggle({ 
        Name = "No apuntar al Team", 
        CurrentValue = false, 
        Callback = function(v) 
            AimbotSettings.TeamCheckEnabled = v 
        end 
    })

    AimbotTab:CreateToggle({ 
        Name = "Verificar Paredes", 
        CurrentValue = false, 
        Callback = function(v) 
            AimbotSettings.WallCheck = v 
        end 
    })

    AimbotTab:CreateToggle({ 
        Name = "Mostrar Líneas (Tracers)", 
        CurrentValue = false, 
        Callback = function(v) 
            AimbotSettings.TracersEnabled = v 
            if not v then HideAllTracers() end
        end 
    })

    AimbotTab:CreateColorPicker({ 
        Name = "Color Líneas (Mi Equipo)", 
        Color = AimbotSettings.TracerColor, 
        Callback = function(v) 
            AimbotSettings.TracerColor = v 
        end 
    })

    AimbotTab:CreateColorPicker({ 
        Name = "Color Líneas (Enemigos)", 
        Color = AimbotSettings.TracerEnemyColor, 
        Callback = function(v) 
            AimbotSettings.TracerEnemyColor = v 
        end 
    })

    AimbotTab:CreateToggle({ 
        Name = "Solo Jugadores Cercanos", 
        CurrentValue = false, 
        Callback = function(v) 
            AimbotSettings.OnlyClosePlayers = v 
        end 
    })

    AimbotTab:CreateSlider({ 
        Name = "Distancia Máxima", 
        Range = {10, 500}, 
        Increment = 5, 
        CurrentValue = AimbotSettings.CloseDistanceThreshold, 
        Callback = function(v) 
            AimbotSettings.CloseDistanceThreshold = v 
        end 
    })

    AimbotTab:CreateToggle({ 
        Name = "Rainbow", 
        CurrentValue = false, 
        Callback = function(v) 
            rainbowEnabled = v 
        end 
    })

    AimbotTab:CreateSlider({ 
        Name = "Velocidad Rainbow", 
        Range = {1, 20}, 
        Increment = 0.5, 
        CurrentValue = rainbowSpeed, 
        Callback = function(v) 
            rainbowSpeed = v 
        end 
    })

    print("Aimbot cargado")
end)
